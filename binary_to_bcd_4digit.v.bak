module binary_to_bcd_4digit(
    input  [15:0] binary,
    output reg [3:0] d0,
    output reg [3:0] d1,
    output reg [3:0] d2,
    output reg [3:0] d3
);
    integer i;
    reg [27:0] shift;

    always @* begin
        shift = 28'd0;
        shift[15:0] = binary;

        for (i = 0; i < 16; i = i + 1) begin
            // Add 3 correction
            if (shift[19:16] >= 5) shift[19:16] = shift[19:16] + 3;
            if (shift[23:20] >= 5) shift[23:20] = shift[23:20] + 3;
            if (shift[27:24] >= 5) shift[27:24] = shift[27:24] + 3;

            // Left shift
            shift = shift << 1;
        end

        d0 = shift[19:16];
        d1 = shift[23:20];
        d2 = shift[27:24];
        d3 = shift[31:28];
    end
endmodule
